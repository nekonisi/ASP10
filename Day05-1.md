Day05-1
===

# 概要

- 簡易スケジュール帳を作成してみよう。

## このレッスンの狙い

- *プログラムから*データベースにアクセスする方法について学習していく。

## Calenderコントロールのイベント

- Calenderコントロールは、月別のカレンダを表示するためのサーバコントロールである。
- ユーザによる操作やASP.NETの内部な処理によって発生するさまざまなイベントを公開している。

### Calenderコントロールの主なイベント

イベント|概要
--------|----
DayRender|カレンダ内の日付セルを作成するタイミングで発生
SelectionChanged|カレンダ上の日付を選択したタイミングで発生
VisibleMonthChanged|カレンダの表示月を変更したタイミングで発生

- 参考書の例では、第2引数として受け取った`DayRenderEventArgs`オブジェクトを介することで、  
現在描画しているセル(`TableCell`オブジェクト)やセルがあらわす日付(`CalenderDay`オブジェクト)などの情報を取得できる。

### CalenderDayクラスの主なプロパティ

プロパティ|概要
----------|----
Date|日付(DateTimeオブジェクト)
DayNumberText|日付(数値)
IsOtherMonth|カレンダで表示された月以外の日付か
IsSelectable|日付は選択可能か
IsSelected|日付は選択されているか
IsToday|今日の日付か
IsWeekend|日付は週末(土日)であるか

`e.Day.Date.ToString("yyyy/MM/dd")`

## データベースに接続する

- ASP.NET(.NET Framework)におけるデータベース接続の手続きは  
きわめて定型的である。

```vb.NET:データベースの定義

Dim setting As ConnectionStringSetting = _
  CongigurationManager.ConnectionStrings("MyDB")
Dim factory As DbProviderFactory = _
  DbProviderFactories.GetFactory(setting.ProviderName)
Using db As DbConnection = factory.CreateConnection()
  db.ConnectionString = setting.ConnectionString
  ...中略...
  db.Open()
  ...中略...
End Using

```

### Using句

- Dim命令によって宣言されていたオブジェクトも、基本的には使用されなくなった後、*任意のタイミング*で自動的に破棄される。

- しかし、複数のユーザで共有している高価なリソースについては、できるだけ早いタイミングで解放をするべきである。
- `Using`命令を使用して宣言されたオブジェクトは、`Using`ブロックが終了したタイミングで自動的に解放される。

#### 構文

```VB.NET:構文

Using 変数名 As データ型 = 式
  ...処理内容...
End Using

Using命令で宣言されたオブジェクト変数はUsingブロックを出た直後に自動的に破棄されます。

```

## データベースにコマンドを追加する

```vb.NET:SQL文の実行

Dim comm As DbCommand = factory.CreateCommand()
comm.CommandText = "SELECT SID,SUBJECT,STIME FROM SCHEDULE WHERE SDATE=@SDATE"
comm.Connection = db

```

### 解説

- SQL文の実行を行うのは、`DbCommand`オブジェクトの役割である。
- DbCommandoオブジェクトは、`DbProvideFactory`オブジェクトの`CreateCommand`メソッドで生成することができる。
- `DbCommand`オブジェクトで、必ず設定しなければならないプロパティは
  1. `CommandText`プロパティ: SQL命令
  1. `Connection`プロパティ: 接続


CommandTextプロパティで指定されたSQL文に対して具体的なパラメータを引き渡しているのは下記の箇所である、

```VB.NET:パラメータの引き渡し

Dim param As DbParameter = factory.CreatePara,ter()
param.ParameterName = "@date"
param.Value = e.Day.Date.ToString("yyyy/MM/dd")
comm.Parameters.Add(param)

```

- パラメメータを管理するのは、`DbParameter`オブジェクトの役割である。
  - `ParameterName`プロパティでパラメータ名を設定できる。
  - `Value`プロパティでパラメータの値を設定できる。
- 作成されたパラメータをコマンドに対して関連付けるには、
  - DbCommandオブジェクトのParameterプロパティを介して取得したSqlParameterCollectionオブジェクトからAddメソッドを呼び出す。
  - あとは、データベースへの接続を開きｍコマンドを実行するだけ

	db.Open()
	Dim render As DbDataReader = comm.ExecuteReader()

## 取得した結果セットの処理

- `ExecuteReader`メソッドは、戻り値として、`DbDataReader`オブジェクトを返す。
  - `DbDataReader`オブジェクトはSELECT命令によって取り出されたレコード群を格納するための仮想的なテーブルを表すと同時に  
、結果セットを先頭から順に読み込むための機能を提供する。

### レコードポインタ

- *結果セット*とはとはいわゆる二次元の表であるが、ASP.NETアプリケーションからこれを読み込む場合、表の任意のフィールドに任意にアクセスするというわけにはいかない。
  - 現在読み込み可能な行を表す内部的な目印として，*レコードポインタ*を使用する。
	- レコードポインタが指し示す現在行のことを，*カレントレコード*という。

#### レコードポインタの移動

```VB.NET:レコードポインタの移動

Do While reader.Read()
 ...中略...
Loop

```

##### 解説

- Readメソッドは，レコードポインタを次のレコードに移動しながら，カレントレコードに含まれるフィールド群を自分自身にfetchしてくる。
- 次のレコードに移動できない場合は，`False`を返す。

### HyperLinkコントロール

- `HyperLink`コントロールは，ハイパーリンクを作成する。

- 主なプロパティは下記の通り

プロパティ|概要
----------|----
ImageUrl|リンクイメージ
NavigateUrl|リンク先のURL
Target|リンクターゲット
Text|リンクテキスト

### 結果セットの取得

#### 構文

`DbDataReaderオブジェクト("インデックス")`

- インデックスには列番号，または結果セットから取得したい列名を直接指定することができる。

### 結果セットの取得2

#### 構文

`DbDataReaderオブジェクト.Get型("インデックス")`

- それぞれ必要に応じて，取得したい型を指定することができる。
  - `GetInt32`
  - `GetBoolean`
  - `GetChar`
  - `GetInt`
  - `GetString`

- 読みにくいので結果セットの取得1をおすすめする。

## データベースアクセス関連のオブジェクトのまとめ

オブジェクト名|概要
--------------|---
ConfigurationManager|接続文字列などの設定情報にアクセス
DbProviderFactory|DbConnectionやDbCommandなどのオブジェクトを生成
DbConnection|データベースの接続を管理
DbCommand|パラメータ情報を管理
DbDataReader|結果セットを読み込むための手段を提供

## まとめ


以上
   
[TOPへ](./index.md)  
