Day10-1
===

# 概要

Global.asaxでエラー処理を記述しよう！

## このレッスンの狙い

- `Global.asax`は、アプリケーション内で発生したイベントを処理するためのファイルである。
- `Global.asax`を利用することで、アクセスログやエラー情報、独自の認証処理、アプリケーション/セッション共通で利用可能なオブジェクトの定義を行うことが可能になる。

## `Global.asax`とは？

- Global.asaxはグローバルアプリケーションファイルとも呼ばれ、アプリケーションで発生する各種イベント(アプリケーションイベント)を処理したり、アプリケーション/セッション共通で利用可能なオブジェクトの宣言を行ったりするために使用する。
  - 共通の処理を記述するためのファイル。
- ファイル名は*Global.asax*固定で、変更することができない。
- `Web.config`とは異なり、必ずアプリケーションルートの直下に配置しなければならない。

### Global.asaxで利用可能なアプリケーションイベント

- Global.asaxで利用可能なイベント

#### 分類: 条件

イベントハンドラ|概要
----------------|----
`Application_Start`|アプリケーションが初回起動した一回のみ発生
`Session_Start`|ユーザセッションが初回起動した1回のみ発生<br>※ セッション変数などを初期化するためなどに使用
`Session_End`|ユーザセッションがクローズしたタイミングで発生<br>※ セッション変数にプールされた情報をDBなどに最終的に保存するために使用する。
`Application_End`|アプリケーションが破棄されたタイミングで発生<br>※ アプリケーション変数にプールされた情報をDBなどに最終的に保存するために使用する。
`Application_Error`|アプリケーション内で処理されない例外(エラー)が発生した場合に発生<br>※エラーログの記録や管理者への通知、エラーページの生成などのために使用

#### 分類: リクエスト

イベントハンドラ|概要
----------------|----
`Application_BeginRequest`|HTTPハンドラがリクエスト処理を開始する前に発生
`Application_AuthenticateRequest`|認証の準備ができたタイミングで発生<br>※ 独自の認証機能を構築したい場合に利用
`Application_PostAuthenticateRequest`|ユーザ認証が完了したタイミングで発生
`Application_AuthorizeRequest`|ユーザが認定されるタイミングで発生
`Application_PostAuthorizeRequest`|ユーザの認定が完了したタイミングで発生
`Application_ResolveRequestCache`|リクエストを、*キャッシュ処理*するタイミングで発生
`Application_PostResolveRequestCache`|ASP.NETがキャッシュからの処理を許可した場合に発生
`Application_PostResolveRequestHandler`|要求が適切なイベントハンドラにマップされたタイミングで発生
`Application_AcquireRequestState`|リクエストに関連づいた状態(セッション状態など)を取得するタイミングで発生<br>※ 独自のセッション管理を行いたい場合に利用
`Application_PostAcquireRequestState`|リクエストに関連づいた状態を取得し終えたタイミングで発生
`Application_PreRequestHandlerExecute`|HTTPハンドラがページの実行を開始する直前に発生
`Application_PostRequestHandlerExecute`|HTTPハンドラがページの実行を開始する直後に発生
`Application_ReleaseRequestState`|すべての実行を完了したタイミングで発生
`Application_PostReleaseRequestState`|リクエストに関連づいた状態をストアに保存し終えたタイミングで発生。<br>※ 本イベントのタイミングで、出力のフォルダ処理なども行われる。

### HTTPのエラーステータス

コード|メッセージ|概要
------|----------|----
400|Bad Request|リクエストの文法が不正
401|Unauthorized|未認証，または認証失敗
403|Forbidden|アクセス拒否
404|Not Found|リソースが見つからない
405|Method Not Allowed|許可されていないHTTPメソッド
406|Not Acceptable|Acceptヘッダで認められていないコンテンツタイプ
407|Proxy Authentication Required|Proxy認証が必要
408|Request Time-out|リクエスト処理がタイムアウト
409|Conflict|リソースの競合
410|Gone|指定アドレスが不明
411|Length Required|Connect-Lengthヘッダが必要
412|Precondigiton Failed|リクエストヘッダが指定する条件が拒否された
413|Request Entry Too Large|リソースが大きすぎる
414|Request-URI Too Large|リクエストURIが長すぎる
415|Unsupported Media Type|サポートされていないフォーマット
416|Requested Range Not Satisfiable|Rangeヘッダが不正
417|Exception Failed|Exceptヘッダが不正
500|Internal Server Error|サーバ内部エラー(ASP.NETの処理などで失敗)
501|Not Implemented|リクエスト処理のために必要な機能が実装されていない
502|Bad Gateway|ゲートウェイやプロキシサーバからの不正な応答
503|Service Unavailiable|HTTPサーバが利用できない
504|Gateway Time-out|ゲートウェイのタイムアウト
505|HTTP Version Not Supported|未サポートのHTTPプロトコルバージョン

#### 飛ばすページの切り分け

- `web.config`の`<customErrors>`タグ内に，切り分けるページを記述する。

```ASP.NET:エラーページの切り分け

<customErrors mode="On" defaultRedirect="error.html">
	<error statusCode="500" redirect="error500.html" />
</customErrors>

```

- カスタムエラーページには，`aspx`を指定することも可能だが，エンドユーザ側の運用担当者がメンテナンスする可能性も考え，*性的なhtml*を指定することが通例

## まとめ

- `Global.asax`はアプリケーションイベントを処理したり，アプリケーション/session共通で利用可能なオブジェクトの宣言を行ったりするために使用する。
- アプリケーションイベントは，特定の条件下でのみ発生する*条件付イベント*と，リクエスト都度に常に発生する*リクエストイベント*に大別することができる。
- ファイルへの書き込みを行うには，`StreamWriter`クラスを利用する。
- アプリケーション上で発生した例外情報は，`Server.GetLastError`メソッドで取得することが可能
- カスタムエラーページとは，運用中のサイトで処理されない例外が発生した場合に表示するエラーページのこと
  - `web.config`の`<customError>`要素で指定することが可能

[TOPへ](./index.md)  
